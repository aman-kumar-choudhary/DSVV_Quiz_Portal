{% extends "admin_base.html" %}

{% block title %}Leaderboard - DSVV Quiz System{% endblock %}

{% block extra_css %}
<style>
    /* Leaderboard row styles */
    .leaderboard-row { transition: all 0.3s ease; }
    .leaderboard-row:hover { background: #f8fafc; }
    .rank-1 { background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; }
    .rank-2 { background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%); border-left: 4px solid #9ca3af; }
    .rank-3 { background: linear-gradient(90deg, #fed7aa 0%, #fdba74 100%); border-left: 4px solid #f97316; }
    
    /* New styles for cascading dropdowns */
    .form-select {
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .input-focus:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6 mt-0">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-trophy text-yellow-600 mr-3"></i> Leaderboard
        </h1>
        <nav class="flex space-x-2 text-sm text-gray-500">
            <a href="/admin" class="hover:text-blue-600">Dashboard</a>
            <span>/</span>
            <span class="text-blue-600">Leaderboard</span>
        </nav>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 text-gray-700">Filter Results</h2>
        <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- School Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">School</label>
                <select name="school" id="school-filter" class="form-select input-focus w-full p-2 border border-gray-300 rounded-lg" onchange="updateDepartmentOptions()">
                    <option value="">All Schools</option>
                    {% for school in schools %}
                    <option value="{{ school }}" {% if selected_school == school %}selected{% endif %}>{{ school }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Department Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                <select name="department" id="department-filter" class="form-select input-focus w-full p-2 border border-gray-300 rounded-lg" onchange="updateCourseOptions()">
                    <option value="">All Departments</option>
                    {% for department in departments %}
                    <option value="{{ department }}" {% if selected_department == department %}selected{% endif %}>{{ department }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Course Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Course</label>
                <select name="course" id="course-filter" class="form-select input-focus w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">All Courses</option>
                    {% for course in courses %}
                    <option value="{{ course }}" {% if selected_course == course %}selected{% endif %}>{{ course }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Semester Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                <select name="semester" class="form-select input-focus w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">All Semesters</option>
                    {% for semester in semesters %}
                    <option value="{{ semester }}" {% if selected_semester == semester %}selected{% endif %}>{{ semester }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Quiz Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Quiz</label>
                <select name="quiz_id" class="form-select input-focus w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">All Quizzes</option>
                    {% for quiz in quizzes %}
                    <option value="{{ quiz.quiz_id }}" {% if selected_quiz == quiz.quiz_id %}selected{% endif %}>{{ quiz.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Limit Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Top Results</label>
                <select name="limit" class="form-select input-focus w-full p-2 border border-gray-300 rounded-lg">
                    <option value="10" {% if limit == 10 %}selected{% endif %}>Top 10</option>
                    <option value="20" {% if limit == 20 %}selected{% endif %}>Top 20</option>
                    <option value="50" {% if limit == 50 %}selected{% endif %}>Top 50</option>
                    <option value="100" {% if limit == 100 %}selected{% endif %}>Top 100</option>
                </select>
            </div>

            <div class="flex items-end md:col-span-4">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    {% if leaderboard %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <table class="min-w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for student in leaderboard %}
                <tr class="leaderboard-row {% if loop.index <= 3 %}rank-{{ loop.index }}{% endif %}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center">{{ loop.index }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ student.user_name }}</div>
                        <div class="text-sm text-gray-500">{{ student.scholar_id }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {{ student.score }}/{{ student.total }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">
                        {{ student.percentage|round(2) }}%
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {{ (student.completion_time / 60)|round(2) }} mins
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {{ student.formatted_date }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {{ student.course }} Sem {{ student.semester }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-white rounded-xl shadow-md p-12 text-center">
        <i class="fas fa-chart-line text-gray-400 text-6xl mb-4"></i>
        <h2 class="text-2xl font-semibold text-gray-800 mb-2">No Leaderboard Data</h2>
        <p class="text-gray-600 mb-6">No quiz results available for the selected filters.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // School and department data (same as signup.html)
    const schoolDepartments = {
        "School of Technology, Communication and Management": [
            "Department of Computer Sciences",
            "Department of Tourism Management",
            "Department of Journalism & Mass Communication",
            "Department of Animation and Visual Effects",
        ],
        "School of Biological Sciences and Sustainability": [
            "Department of Rural Studies and Sustainability",
        ],
        "School of Indology": [
            "Department of Sanskrit and Vedic Studies",
            "Department of Hindi",
            "Department of Indian Classical Music",
            "Department of History and Indian Culture",
        ],
        "School of Humanities, Social Sciences and Foundation Courses": [
            "Department of English",
            "Department of Education",
            "Department of Psychology",
            "Department of Life Management",
            "Department of Scientific Spirituality",
            "Department of Oriental Studies, Religious Studies & Philosophy",
            "Department of Yogic Sciences and Human Consciousness",
        ],
    };

    const departmentCourses = {
        "Department of Computer Sciences": [
            "B.Sc. Information Technology (Honors)",
            "Bachelor of Computer Application (Honors)",
            "Master of Computer Application (Data Science)",
        ],
        "Department of Tourism Management": [
            "B.B.A Tourism & Travel Management (Honors)",
            "M.B.A. Tourism & Travel Management",
        ],
        "Department of Journalism & Mass Communication": [
            "B.A. Journalism and Mass Communication (Honors)",
            "M. A. Journalism and Mass Communication",
            "M. A. Spiritual Journalism",
        ],
        "Department of Animation and Visual Effects": [
            "B.Voc. (Bachelor of Vocation) in 3D Animation and VFX (Honors)",
        ],
        "Department of Rural Studies and Sustainability": [
            "Bachelor of Rural Studies (Honors)",
        ],
        "Department of English": ["B.A. English (Honors)"],
        "Department of Education": ["B.Ed. (Bachelor of Education)"],
        "Department of Psychology": [
            "B.A. Psychology (Honors)",
            "M.A. Counselling Psychology",
            "M.Sc. Counselling Psychology",
        ],
        "Department of Life Management": [
            "Life Management - Compulsory Program for PG and UG",
        ],
        "Department of Scientific Spirituality": [
            "M.Sc. Herbal Medicine and Natural Product Chemistry",
            "M.Sc. Molecular Physiology and Traditional Health Sciences",
            "M.Sc. Indigenous Approaches for Child Development & Generational Dynamics",
            "M.Sc. Indian Knowledge Systems",
            "M.A. Indian Knowledge Systems",
        ],
        "Department of Oriental Studies, Religious Studies & Philosophy": [
            "M.A. Hindu Studies",
            "M.A. Philosophy",
        ],
        "Department of Yogic Sciences and Human Consciousness": [
            "B.Sc. Yogic Science (Honors)",
            "M.Sc. Yoga Therapy",
            "M.A. Human Consciousness & Yogic Science",
            "M.Sc. Human Consciousness & Yogic Science",
            "P. G. Diploma Human Consciousness, Yoga & Alternative Therapy",
            "Certificate In Yoga And Alternative Therapy",
        ],
        "Department of Sanskrit and Vedic Studies": [
            "B.A. Sanskrit (Honors)",
            "M.A. Sanskrit",
        ],
        "Department of Hindi": ["B.A. Hindi (Honors)", "M.A. Hindi"],
        "Department of Indian Classical Music": [
            "B.A. Music (Vocal) (Honors)",
            "M.A. Music (Vocal)",
            "B.A. Music Instrumental Mridang/Tabla (Honors)",
            "M.A. Music (Tabla, Pakhaawaj)",
        ],
        "Department of History and Indian Culture": [
            "B.A. History (Honors)",
            "M. A. History and Indian Culture",
        ],
    };

    // Filter dropdown functionality
    function updateDepartmentOptions() {
        const schoolSelect = document.getElementById('school-filter');
        const departmentSelect = document.getElementById('department-filter');
        const selectedSchool = schoolSelect.value;
        
        // Reset and disable dependent dropdowns
        departmentSelect.innerHTML = '<option value="">All Departments</option>';
        document.getElementById('course-filter').innerHTML = '<option value="">All Courses</option>';
        
        if (selectedSchool) {
            // Populate departments based on selected school
            const departments = schoolDepartments[selectedSchool] || [];
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
        }
    }

    function updateCourseOptions() {
        const departmentSelect = document.getElementById('department-filter');
        const courseSelect = document.getElementById('course-filter');
        const selectedDepartment = departmentSelect.value;
        
        // Reset course dropdown
        courseSelect.innerHTML = '<option value="">All Courses</option>';
        
        if (selectedDepartment) {
            // Populate courses based on selected department
            const courses = departmentCourses[selectedDepartment] || [];
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                courseSelect.appendChild(option);
            });
        }
    }

    // Initialize dropdowns on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateDepartmentOptions();
        updateCourseOptions();
        
        // Set initial values if filters are already applied
        const schoolFilter = document.getElementById('school-filter');
        const departmentFilter = document.getElementById('department-filter');
        const courseFilter = document.getElementById('course-filter');
        
        if (schoolFilter.value) {
            updateDepartmentOptions();
            if (departmentFilter.value) {
                updateCourseOptions();
            }
        }
    });
</script>
{% endblock %}