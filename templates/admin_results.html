{% extends "admin_base.html" %}

{% block title %}Results Management - DSVV Quiz System{% endblock %}

{% block extra_css %}
<style>
    .bulk-actions {
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    /* New styles for cascading dropdowns */
    .form-select {
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .input-focus:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
    
    /* Leaderboard row styles */
    .leaderboard-row { transition: all 0.3s ease; }
    .leaderboard-row:hover { background: #f8fafc; }
</style>
{% endblock %}

{% block content %}
<main class="p-6 mt-0">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-chart-bar text-blue-600 mr-3"></i> Results Management
        </h1>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-700">
            <i class="fas fa-filter mr-2"></i> Filter Results
        </h2>
        <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- School Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">School</label>
                <select name="school" id="school-filter" class="form-select input-focus w-full p-2 border border-gray-300 rounded-md" onchange="updateDepartmentOptions()">
                    <option value="">All Schools</option>
                    {% for school in schools %}
                    <option value="{{ school }}" {% if selected_school == school %}selected{% endif %}>{{ school }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Department Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                <select name="department" id="department-filter" class="form-select input-focus w-full p-2 border border-gray-300 rounded-md" onchange="updateCourseOptions()">
                    <option value="">All Departments</option>
                    {% for department in departments %}
                    <option value="{{ department }}" {% if selected_department == department %}selected{% endif %}>{{ department }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Course Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Course</label>
                <select name="course" id="course-filter" class="form-select input-focus w-full p-2 border border-gray-300 rounded-md">
                    <option value="">All Courses</option>
                    {% for course in courses %}
                    <option value="{{ course }}" {% if selected_course == course %}selected{% endif %}>{{ course }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Semester Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                <select name="semester" class="form-select input-focus w-full p-2 border border-gray-300 rounded-md">
                    <option value="">All Semesters</option>
                    {% for semester in semesters %}
                    <option value="{{ semester }}" {% if selected_semester == semester %}selected{% endif %}>{{ semester }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex items-end md:col-span-4">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-full mr-4">
                    <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Total Students</p>
                    <p class="text-2xl font-bold text-gray-800">{{ stats.total_students }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-full mr-4">
                    <i class="fas fa-chart-pie text-green-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Total Quizzes</p>
                    <p class="text-2xl font-bold text-gray-800">{{ stats.total_quizzes }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
            <div class="flex items-center">
                <div class="p-3 bg-yellow-100 rounded-full mr-4">
                    <i class="fas fa-check-circle text-yellow-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Average Score</p>
                    <p class="text-2xl font-bold text-gray-800">{{ stats.average_score | round(2) }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if top_students %}
    <div class="bg-white p-6 rounded-xl shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 flex items-center text-green-700">
            <i class="fas fa-trophy mr-2"></i> Top 5 Performers
            {% if selected_course and selected_course != 'All' %} in {{ selected_course }}{% endif %}
            {% if selected_semester and selected_semester != 'All' %} - Semester {{ selected_semester }}{% endif %}
        </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scholar ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Taken</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for student in top_students %}
                    <tr class="{% if loop.index < 4 %}leaderboard-row{% else %}hover:bg-gray-50{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center">
                            {% if loop.index == 1 %}1{% elif loop.index == 2 %}2{% elif loop.index == 3 %}3{% else %}{{ loop.index }}{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">{{ student.user_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ student.scholar_id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ student.score }}/{{ student.total }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">{{ student.percentage | round(2) }}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ (student.completion_time / 60) | round(2) }} mins</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ student.timestamp.strftime('%Y-%m-%d') if student.timestamp else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="bg-white p-6 rounded-xl shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 flex items-center text-green-700">
            <i class="fas fa-list mr-2"></i> Detailed Results
        </h2>
        
        <!-- Bulk Actions -->
        <div class="bulk-actions mb-4 flex items-center space-x-4">
            <div class="flex items-center">
                <input type="checkbox" id="select-all" class="mr-2">
                <label for="select-all" class="text-sm text-gray-700">Select All</label>
            </div>
            <button onclick="bulkPublishResults()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                <i class="fas fa-check-circle mr-1"></i> Publish Selected
            </button>
            <button onclick="exportResults()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                <i class="fas fa-download mr-1"></i> Export Results
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scholar ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semester</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Taken</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for result in results %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if not result.published %}
                            <input type="checkbox" name="result-checkbox" value="{{ result.workspace_id }}" class="result-checkbox">
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ result.scholar_id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">{{ result.user_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ result.course }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ result.semester }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ result.score }}/{{ result.total }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">{{ (result.score/result.total*100) | round(2) }}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ (result.completion_time / 60) | round(2) }} mins</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ result.timestamp.strftime('%Y-%m-%d %H:%M') if result.timestamp else 'N/A' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 rounded-full text-xs {% if result.published %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ 'Published' if result.published else 'Pending' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if not result.published %}
                            <button onclick="publishResult('{{ result.workspace_id }}')" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                Publish
                            </button>
                            {% else %}
                            <span class="text-green-600 text-xs">Published</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if not results %}
        <div class="text-center py-8">
            <i class="fas fa-exclamation-triangle text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-500">No results found</p>
            <p class="text-sm text-gray-400 mt-2">Try adjusting your filters to see results</p>
        </div>
        {% endif %}
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    // School and department data (same as signup.html)
    const schoolDepartments = {
        "School of Technology, Communication and Management": [
            "Department of Computer Sciences",
            "Department of Tourism Management",
            "Department of Journalism & Mass Communication",
            "Department of Animation and Visual Effects",
        ],
        "School of Biological Sciences and Sustainability": [
            "Department of Rural Studies and Sustainability",
        ],
        "School of Indology": [
            "Department of Sanskrit and Vedic Studies",
            "Department of Hindi",
            "Department of Indian Classical Music",
            "Department of History and Indian Culture",
        ],
        "School of Humanities, Social Sciences and Foundation Courses": [
            "Department of English",
            "Department of Education",
            "Department of Psychology",
            "Department of Life Management",
            "Department of Scientific Spirituality",
            "Department of Oriental Studies, Religious Studies & Philosophy",
            "Department of Yogic Sciences and Human Consciousness",
        ],
    };

    const departmentCourses = {
        "Department of Computer Sciences": [
            "B.Sc. Information Technology (Honors)",
            "Bachelor of Computer Application (Honors)",
            "Master of Computer Application (Data Science)",
        ],
        "Department of Tourism Management": [
            "B.B.A Tourism & Travel Management (Honors)",
            "M.B.A. Tourism & Travel Management",
        ],
        "Department of Journalism & Mass Communication": [
            "B.A. Journalism and Mass Communication (Honors)",
            "M. A. Journalism and Mass Communication",
            "M. A. Spiritual Journalism",
        ],
        "Department of Animation and Visual Effects": [
            "B.Voc. (Bachelor of Vocation) in 3D Animation and VFX (Honors)",
        ],
        "Department of Rural Studies and Sustainability": [
            "Bachelor of Rural Studies (Honors)",
        ],
        "Department of English": ["B.A. English (Honors)"],
        "Department of Education": ["B.Ed. (Bachelor of Education)"],
        "Department of Psychology": [
            "B.A. Psychology (Honors)",
            "M.A. Counselling Psychology",
            "M.Sc. Counselling Psychology",
        ],
        "Department of Life Management": [
            "Life Management - Compulsory Program for PG and UG",
        ],
        "Department of Scientific Spirituality": [
            "M.Sc. Herbal Medicine and Natural Product Chemistry",
            "M.Sc. Molecular Physiology and Traditional Health Sciences",
            "M.Sc. Indigenous Approaches for Child Development & Generational Dynamics",
            "M.Sc. Indian Knowledge Systems",
            "M.A. Indian Knowledge Systems",
        ],
        "Department of Oriental Studies, Religious Studies & Philosophy": [
            "M.A. Hindu Studies",
            "M.A. Philosophy",
        ],
        "Department of Yogic Sciences and Human Consciousness": [
            "B.Sc. Yogic Science (Honors)",
            "M.Sc. Yoga Therapy",
            "M.A. Human Consciousness & Yogic Science",
            "M.Sc. Human Consciousness & Yogic Science",
            "P. G. Diploma Human Consciousness, Yoga & Alternative Therapy",
            "Certificate In Yoga And Alternative Therapy",
        ],
        "Department of Sanskrit and Vedic Studies": [
            "B.A. Sanskrit (Honors)",
            "M.A. Sanskrit",
        ],
        "Department of Hindi": ["B.A. Hindi (Honors)", "M.A. Hindi"],
        "Department of Indian Classical Music": [
            "B.A. Music (Vocal) (Honors)",
            "M.A. Music (Vocal)",
            "B.A. Music Instrumental Mridang/Tabla (Honors)",
            "M.A. Music (Tabla, Pakhaawaj)",
        ],
        "Department of History and Indian Culture": [
            "B.A. History (Honors)",
            "M. A. History and Indian Culture",
        ],
    };

    // Filter dropdown functionality
    function updateDepartmentOptions() {
        const schoolSelect = document.getElementById('school-filter');
        const departmentSelect = document.getElementById('department-filter');
        const selectedSchool = schoolSelect.value;
        
        // Reset and disable dependent dropdowns
        departmentSelect.innerHTML = '<option value="">All Departments</option>';
        document.getElementById('course-filter').innerHTML = '<option value="">All Courses</option>';
        
        if (selectedSchool) {
            // Populate departments based on selected school
            const departments = schoolDepartments[selectedSchool] || [];
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
        }
    }

    function updateCourseOptions() {
        const departmentSelect = document.getElementById('department-filter');
        const courseSelect = document.getElementById('course-filter');
        const selectedDepartment = departmentSelect.value;
        
        // Reset course dropdown
        courseSelect.innerHTML = '<option value="">All Courses</option>';
        
        if (selectedDepartment) {
            // Populate courses based on selected department
            const courses = departmentCourses[selectedDepartment] || [];
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                courseSelect.appendChild(option);
            });
        }
    }

    // Initialize dropdowns on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateDepartmentOptions();
        updateCourseOptions();
        
        // Set initial values if filters are already applied
        const schoolFilter = document.getElementById('school-filter');
        const departmentFilter = document.getElementById('department-filter');
        const courseFilter = document.getElementById('course-filter');
        
        if (schoolFilter.value) {
            updateDepartmentOptions();
            if (departmentFilter.value) {
                updateCourseOptions();
            }
        }

        // Select all functionality
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.result-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    });

    // Publish single result
    function publishResult(workspace_id) {
        if (confirm('Are you sure you want to publish this result?')) {
            fetch('/publish_results', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({workspace_id})
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert(data.message);
                      location.reload();
                  } else {
                      alert(data.error || 'Failed to publish');
                  }
              }).catch(error => {
                  alert('Error: ' + error);
              });
        }
    }

    // Bulk publish results
    function bulkPublishResults() {
        const selectedCheckboxes = document.querySelectorAll('.result-checkbox:checked');
        const workspaceIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
        
        if (workspaceIds.length === 0) {
            alert('Please select at least one result to publish.');
            return;
        }
        
        if (confirm(`Are you sure you want to publish ${workspaceIds.length} results?`)) {
            console.log('Sending bulk publish request with IDs:', workspaceIds);
            
            fetch('/api/bulk_publish_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({workspace_ids: workspaceIds})
            })
            .then(response => {
                console.log('Response status:', response.status, response.statusText);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}. Response: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.error || 'Failed to publish results');
                }
            })
            .catch(error => {
                console.error('Error details:', error);
                alert('Error: ' + error.message);
            });
        }
    }

    // Export results
    function exportResults() {
        const school = document.getElementById('school-filter').value || '';
        const department = document.getElementById('department-filter').value || '';
        const course = document.getElementById('course-filter').value || '';
        const semester = document.querySelector('select[name="semester"]').value || '';
        
        const params = new URLSearchParams();
        if (school) params.append('school', school);
        if (department) params.append('department', department);
        if (course) params.append('course', course);
        if (semester) params.append('semester', semester);
        
        window.location.href = '/export_results?' + params.toString();
    }
</script>
{% endblock %}