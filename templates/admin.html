{% extends "admin_base.html" %} {% block title %}Admin Panel - DSVV Quiz
System{% endblock %} {% block content %}
<!-- Dashboard Content -->
<main class="p-6 mt-0">
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6"
  >
    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
      <i class="fas fa-chart-line text-blue-600 mr-3"></i>
      {% if session.role == 'coordinator' %} Coordinator Dashboard {% elif
      session.role == 'faculty' %} Faculty Dashboard {% else %} Admin Dashboard
      {% endif %}
    </h1>
    <div
      class="mt-4 md:mt-0 text-sm text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm"
    >
      <i class="fas fa-user-tag mr-2 text-blue-500"></i>
      {{ session.role|title }} Access
    </div>
  </div>

  <!-- Role-based Welcome Messages -->
  {% if session.role == 'coordinator' %}
  <!-- Coordinator-specific dashboard -->
  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <i class="fas fa-user-tie text-yellow-400 text-xl"></i>
      </div>
      <div class="ml-3">
        <p class="text-sm text-yellow-700">
          <strong>Welcome, Coordinator!</strong> You can upload questions,
          review submissions, and view results.
        </p>
      </div>
    </div>
  </div>
  {% elif session.role == 'faculty' %}
  <!-- Faculty-specific dashboard -->
  <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <i class="fas fa-chalkboard-teacher text-blue-400 text-xl"></i>
      </div>
      <div class="ml-3">
        <p class="text-sm text-blue-700">
          <strong>Welcome, Faculty!</strong> You can manage questions, create
          quizzes, and analyze results.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div
      class="stats-card bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500"
    >
      <div class="flex items-center">
        <div class="p-3 bg-blue-100 rounded-full mr-4">
          <i class="fas fa-users text-blue-600 text-xl"></i>
        </div>
        <div>
          <p class="text-sm text-gray-500">Total Students</p>
          <p class="text-2xl font-bold text-gray-800">
            {{ stats.total_students }}
          </p>
        </div>
      </div>
    </div>

    <div
      class="stats-card bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500"
    >
      <div class="flex items-center">
        <div class="p-3 bg-green-100 rounded-full mr-4">
          <i class="fas fa-file-alt text-green-600 text-xl"></i>
        </div>
        <div>
          <p class="text-sm text-gray-500">Total Questions</p>
          <p class="text-2xl font-bold text-gray-800">
            {{ stats.total_questions }}
          </p>
        </div>
      </div>
    </div>

    <div
      class="stats-card bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500"
    >
      <div class="flex items-center">
        <div class="p-3 bg-purple-100 rounded-full mr-4">
          <i class="fas fa-chart-pie text-purple-600 text-xl"></i>
        </div>
        <div>
          <p class="text-sm text-gray-500">Quizzes Taken</p>
          <p class="text-2xl font-bold text-gray-800">
            {{ stats.total_quizzes }}
          </p>
        </div>
      </div>
    </div>

    <div
      class="stats-card bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500"
    >
      <div class="flex items-center">
        <div class="p-3 bg-yellow-100 rounded-full mr-4">
          <i class="fas fa-check-circle text-yellow-600 text-xl"></i>
        </div>
        <div>
          <p class="text-sm text-gray-500">Avg. Score</p>
          <p class="text-2xl font-bold text-gray-800">
            {{ stats.average_score | round(2) }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Quizzes Section -->
  {% if stats.active_quizzes and session.role in ['admin', 'faculty'] %}
  <div class="bg-white p-6 rounded-xl shadow-md mb-8 card-hover">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
      <i class="fas fa-play-circle text-green-500 mr-3"></i> Active Quizzes
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for quiz in stats.active_quizzes %}
      <div class="quiz-active p-4 rounded-lg border border-gray-200">
        <div class="flex justify-between items-start mb-2">
          <h3 class="font-semibold text-blue-700">
            {{ quiz.course }} - Sem {{ quiz.semester }}
          </h3>
          <span
            class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full"
            >Active</span
          >
        </div>
        <p class="text-sm text-gray-600 mb-3">
          Duration: {{ quiz.duration }} minutes
        </p>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Daily Leaderboard Section -->
  {% if session.role in ['admin', 'faculty'] %}
  <div class="bg-white p-6 rounded-xl shadow-md mb-8 card-hover">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
      <i class="fas fa-trophy text-yellow-500 mr-3"></i> Daily Leaderboard
    </h2>

    <div class="relative mb-8">
      <div class="flex justify-between items-center mb-4">
        <h3 id="slider-date-label" class="text-lg font-semibold text-gray-700">
          Today's Top Performers
        </h3>
        <div class="flex space-x-2">
          <button
            id="prev-day"
            class="bg-gray-200 hover:bg-gray-300 rounded-full p-2 transition-colors"
          >
            <i class="fas fa-chevron-left"></i>
          </button>
          <button
            id="next-day"
            class="bg-gray-200 hover:bg-gray-300 rounded-full p-2 transition-colors"
          >
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <div
        id="daily-leaderboard"
        class="overflow-x-auto rounded-lg border border-gray-200"
      >
        <!-- Daily leaderboard will be loaded here by JavaScript -->
        <div class="text-center py-8">
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"
          ></div>
          <p class="mt-4 text-gray-600">Loading leaderboard data...</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Quick Actions - Show based on role -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Question Management - Available to all roles -->
    <div class="bg-white p-6 rounded-xl shadow-md card-hover">
      <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-700">
        <i class="fas fa-question-circle mr-2"></i> Question Management
      </h2>
      <p class="text-gray-500 mb-4">
        Manage your question bank, add new questions, or edit existing ones.
      </p>
      <div class="flex space-x-3">
        <a
          href="/admin/questions/management"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
        >
          Manage Questions
        </a>
        {% if session.role in ['admin', 'faculty', 'coordinator'] %}
        <a
          href="/admin/questions/upload"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
        >
          Add New
        </a>
        {% endif %}
      </div>
    </div>

    <!-- Results Analytics - Available to all roles -->
    <div class="bg-white p-6 rounded-xl shadow-md card-hover">
      <h2 class="text-xl font-semibold mb-4 flex items-center text-green-700">
        <i class="fas fa-chart-bar mr-2"></i> Results Analytics
      </h2>
      <p class="text-gray-500 mb-4">
        View student results and analyze performance data.
      </p>
      <div class="flex space-x-3">
        <a
          href="/admin/results"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
        >
          View Results
        </a>
      </div>
    </div>

    <!-- Quiz Management - Only for Admin and Faculty -->
    {% if session.role in ['admin', 'faculty'] %}
    <div class="bg-white p-6 rounded-xl shadow-md card-hover">
      <h2 class="text-xl font-semibold mb-4 flex items-center text-purple-700">
        <i class="fas fa-rocket mr-2"></i> Quiz Management
      </h2>
      <p class="text-gray-500 mb-4">
        Create and manage quizzes for different courses.
      </p>
      <div class="flex space-x-3">
        <a
          href="/admin/quizzes"
          class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
        >
          Manage Quizzes
        </a>
      </div>
    </div>
    {% endif %}

    <!-- Leaderboard - Only for Admin and Faculty -->
    {% if session.role in ['admin', 'faculty'] %}
    <div class="bg-white p-6 rounded-xl shadow-md card-hover">
      <h2 class="text-xl font-semibold mb-4 flex items-center text-yellow-700">
        <i class="fas fa-trophy mr-2"></i> Leaderboard
      </h2>
      <p class="text-gray-500 mb-4">
        View top performers and student rankings.
      </p>
      <div class="flex space-x-3">
        <a
          href="/admin/leaderboard"
          class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
        >
          View Leaderboard
        </a>
      </div>
    </div>
    {% endif %}

    <!-- User Management - Only for Admin -->
    {% if session.role == 'admin' %}
    <div class="bg-white p-6 rounded-xl shadow-md card-hover">
      <h2 class="text-xl font-semibold mb-4 flex items-center text-red-700">
        <i class="fas fa-users mr-2"></i> User Management
      </h2>
      <p class="text-gray-500 mb-4">Manage students and admin users.</p>
      <div class="flex space-x-3">
        <a
          href="/admin/users"
          class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
        >
          Manage Users
        </a>
      </div>
    </div>
    {% endif %}

    <!-- Admin Users Management - Only for Super Admin -->
    {% if session.user_type == 'super_admin' %}
    <div class="bg-white p-6 rounded-xl shadow-md card-hover">
      <h2 class="text-xl font-semibold mb-4 flex items-center text-indigo-700">
        <i class="fas fa-user-shield mr-2"></i> Admin Users
      </h2>
      <p class="text-gray-500 mb-4">
        Manage admin, faculty, and coordinator accounts.
      </p>
      <div class="flex space-x-3">
        <a
          href="/admin/users/manage-admins"
          class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
        >
          Manage Admins
        </a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Recent Activities and Feedback Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Recent Activities -->
    <div class="bg-white p-6 rounded-xl shadow-md">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
          <i class="fas fa-history text-blue-600 mr-2"></i> Recent Activities
        </h2>
        <a href="#" class="text-blue-600 text-sm hover:underline">View All</a>
      </div>

      <div class="space-y-4 max-h-96 overflow-y-auto">
        {% if stats.recent_activities %} {% for activity in
        stats.recent_activities %}
        <div class="activity-item p-4 bg-gray-50 rounded-lg">
          <div class="flex justify-between items-start mb-1">
            <span class="text-sm font-medium text-gray-700">
              {% if activity.scholar_id %} {{ activity.scholar_id }} {% else %}
              System {% endif %}
            </span>
            <span class="text-xs text-gray-500">
              {{ activity.timestamp.strftime('%H:%M') }}
            </span>
          </div>
          <p class="text-sm text-gray-600 mb-1">{{ activity.description }}</p>
          <div class="text-xs text-gray-400">
            {{ activity.timestamp.strftime('%b %d, %Y') }} {% if activity.course
            %} • {{ activity.course }} Sem {{ activity.semester }} {% endif %}
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="text-center py-8">
          <i class="fas fa-history text-gray-400 text-4xl mb-4"></i>
          <p class="text-gray-500">No recent activities</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Recent Feedback -->
    <div class="bg-white p-6 rounded-xl shadow-md">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
          <i class="fas fa-comment-alt text-green-600 mr-2"></i> Recent Feedback
        </h2>
        <a href="#" class="text-blue-600 text-sm hover:underline">View All</a>
      </div>

      <div class="space-y-4 max-h-96 overflow-y-auto">
        {% if stats.recent_feedback %} {% for feedback in stats.recent_feedback
        %}
        <div class="feedback-item p-4 bg-gray-50 rounded-lg">
          <div class="flex justify-between items-start mb-2">
            <span class="text-sm font-medium text-gray-700">
              {{ feedback.name }} ({{ feedback.scholar_id }})
            </span>
            <div class="flex items-center">
              {% for i in range(5) %} {% if i < feedback.rating %}
              <i class="fas fa-star text-yellow-400 text-xs"></i>
              {% else %}
              <i class="far fa-star text-yellow-400 text-xs"></i>
              {% endif %} {% endfor %}
            </div>
          </div>
          <p class="text-sm text-gray-600 mb-2">{{ feedback.text }}</p>
          <div class="text-xs text-gray-400">
            {{ feedback.timestamp.strftime('%b %d, %Y %H:%M') }} {% if
            feedback.course %} • {{ feedback.course }} Sem {{ feedback.semester
            }} {% endif %}
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="text-center py-8">
          <i class="fas fa-comment-alt text-gray-400 text-4xl mb-4"></i>
          <p class="text-gray-500">No feedback received yet</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</main>
{% endblock %} {% block extra_js %} {% if session.role in ['admin', 'faculty']
%}
<script>
  // Page-specific JavaScript for admin dashboard
  document.addEventListener("DOMContentLoaded", function () {
    // Only load leaderboard if user has access

    const dateLabel = document.getElementById("slider-date-label");
    const dailyLeaderboard = document.getElementById("daily-leaderboard");
    const prevBtn = document.getElementById("prev-day");
    const nextBtn = document.getElementById("next-day");

    let currentDateIndex = 0;
    let dateData = [];

    // Fetch date-based leaderboard data
    fetch("/api/daily_leaderboard")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        dateData = data.dates;
        updateLeaderboard();
      })
      .catch((error) => {
        console.error("Error loading leaderboard:", error);
        if (dailyLeaderboard) {
          dailyLeaderboard.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
              <p class="text-gray-500">Error loading leaderboard data.</p>
              <p class="text-sm text-gray-400 mt-2">Please try refreshing the page.</p>
            </div>
          `;
        }
      });

    function updateDateLabel() {
      if (dateData.length > 0 && dateData[currentDateIndex]) {
        const date = new Date(dateData[currentDateIndex].date);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        let dateText;
        if (date.toDateString() === today.toDateString()) {
          dateText = "Today's Top Performers";
        } else if (date.toDateString() === yesterday.toDateString()) {
          dateText = "Yesterday's Top Performers";
        } else {
          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const year = String(date.getFullYear()).slice(-2);
          dateText = `Top Performers on ${day}/${month}/${year}`;
        }

        dateLabel.textContent = dateText;

        // Update button states
        if (prevBtn) prevBtn.disabled = currentDateIndex === 0;
        if (nextBtn)
          nextBtn.disabled = currentDateIndex === dateData.length - 1;

        if (prevBtn) {
          if (prevBtn.disabled) {
            prevBtn.classList.add("opacity-50", "cursor-not-allowed");
            prevBtn.classList.remove("hover:bg-gray-300");
          } else {
            prevBtn.classList.remove("opacity-50", "cursor-not-allowed");
            prevBtn.classList.add("hover:bg-gray-300");
          }
        }

        if (nextBtn) {
          if (nextBtn.disabled) {
            nextBtn.classList.add("opacity-50", "cursor-not-allowed");
            nextBtn.classList.remove("hover:bg-gray-300");
          } else {
            nextBtn.classList.remove("opacity-50", "cursor-not-allowed");
            nextBtn.classList.add("hover:bg-gray-300");
          }
        }
      }
    }

    function updateLeaderboard() {
      if (dateData.length > 0 && dateData[currentDateIndex]) {
        const leaders = dateData[currentDateIndex].leaders;

        if (leaders.length > 0) {
          dailyLeaderboard.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sem</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${leaders
                  .map(
                    (student, index) => `
                  <tr class="${
                    index < 3 ? "leaderboard-row" : "hover:bg-gray-50"
                  }">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center">${
                      index + 1
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${
                      student.user_name
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${
                      student.course || "N/A"
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${
                      student.semester || "N/A"
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${
                      student.score
                    }/${student.total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">${
                      student.percentage ? student.percentage.toFixed(2) : 0
                    }%</td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          `;
        } else {
          dailyLeaderboard.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
              <p class="text-gray-500">No quiz results for this date.</p>
            </div>
          `;
        }

        updateDateLabel();
      } else if (dateData.length === 0) {
        dailyLeaderboard.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-500">No leaderboard data available yet.</p>
            <p class="text-sm text-gray-400 mt-2">Check back after quizzes have been completed.</p>
          </div>
        `;
      }
    }

    if (prevBtn) {
      prevBtn.addEventListener("click", function () {
        if (currentDateIndex > 0) {
          currentDateIndex--;
          updateLeaderboard();
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", function () {
        if (currentDateIndex < dateData.length - 1) {
          currentDateIndex++;
          updateLeaderboard();
        }
      });
    }
  });
</script>
{% endif %} {% endblock %}
